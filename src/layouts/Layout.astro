---
import "@fontsource-variable/onest"

import Header from "../components/Header.astro"
import Footer from "../components/Footer.astro"

interface Props {
  title: string
  description: string
}

const { description, title } = Astro.props
---

<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <script>
      // Anti-flash de tema: forzar modo oscuro por defecto
      (function(){
        try{
          const saved = localStorage.getItem('theme');
          // Si el usuario eligió explícitamente 'light', respetamos eso.
          // En cualquier otro caso (sin valor o 'dark'), usamos dark por defecto.
          if (saved !== 'light') {
            document.documentElement.classList.add('dark');
          }
        }catch(_){}
      })();
    </script>
    <style>
      /* View Transitions para el contenedor de página */
      .vt-container { view-transition-name: page; }
      @keyframes vt-fade-in { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
      @keyframes vt-fade-out { from { opacity: 1; transform: translateY(0); } to { opacity: 0; transform: translateY(-4px); } }
      ::view-transition-old(page) { animation: vt-fade-out 180ms ease forwards; }
      ::view-transition-new(page) { animation: vt-fade-in 180ms ease forwards; }
      /* Evitar animación indeseada en Excalidraw al cambiar tema */
      html:root { transition: color 0.2s ease, background-color 0.2s ease; }
      [data-excal] * { transition: none !important; }
    </style>
  </head>

  <body class="relative text-black dark:text-white">
    <div
      class="absolute top-0 bottom-0 z-[-2] min-h-screen w-full bg-decor"
    >
    </div>
    <Header />
    <main id="app" class="vt-container">
      <slot />
    </main>
    <Footer />

    <script>
      // Navegación con View Transitions sin reemplazar <body>
      (function(){
        const supportsVT = 'startViewTransition' in document;
        const appSelector = '#app';

        function shouldHandleLink(e: MouseEvent){
          if ((e as any).defaultPrevented) return false;
          if (e.metaKey || e.ctrlKey || e.shiftKey || e.altKey || e.button !== 0) return false;
          const target = e.target as Element | null;
          const a = target?.closest?.('a');
          if (!a) return false;
          const href = a.getAttribute('href') || '';
          // No interceptar enlaces con hash (anclas), aunque usen "/#id"
          if (href.includes('#') || a.hasAttribute('download')) return false;
          const url = new URL((a as HTMLAnchorElement).href, location.href);
          // Permitir interceptar navegación entre páginas internas (excepto anclas y externos)
          if (url.origin !== location.origin) return false;
          return true;
        }

        function reviveScripts(root: Element){
          const scripts = root.querySelectorAll('script');
          scripts.forEach((oldScript) => {
            const s = document.createElement('script');
            for (const { name, value } of Array.from(oldScript.attributes)) {
              s.setAttribute(name, value);
            }
            s.textContent = oldScript.textContent || '';
            oldScript.replaceWith(s);
          });
        }

        async function load(url: string){
          // Resetear scroll inmediatamente antes de cargar el contenido
          window.scrollTo({ top: 0, behavior: 'instant' });
          
          const res = await fetch(url, { headers: { 'X-Requested-With': 'view-transition' } });
          const html = await res.text();
          const doc = new DOMParser().parseFromString(html, 'text/html');
          const next = doc.querySelector(appSelector);
          if (!next) throw new Error('Contenedor no encontrado');
          document.title = doc.title;
          const current = document.querySelector(appSelector);
          if (!current) return;
          current.replaceChildren(...Array.from(next.childNodes));
          reviveScripts(current);
          // Rehidratar islas de Astro tras el swap para que componentes client-only/visible se monten
          try { window.dispatchEvent(new Event('astro:page-load')); } catch {}
          
          // Asegurar que el scroll esté en 0 después de cargar
          window.scrollTo({ top: 0, behavior: 'instant' });
        }

        addEventListener('click', (e: MouseEvent) => {
          if (!shouldHandleLink(e)) return;
          const a = (e.target as Element | null)?.closest?.('a') as HTMLAnchorElement | null;
          if (!a) return;
          const url = new URL(a.href, location.href);
          e.preventDefault();
          if (supportsVT){
            (document as any).startViewTransition(() => load(url.toString())).finished.then(() => {
              history.pushState(null, '', url.toString());
              // El scroll ya se reseteó en load(), pero aseguramos aquí también
              window.scrollTo({ top: 0, behavior: 'instant' });
            }).catch(() => location.href = url.toString());
          } else {
            load(url.toString()).then(() => {
              history.pushState(null, '', url.toString());
              // El scroll ya se reseteó en load(), pero aseguramos aquí también
              window.scrollTo({ top: 0, behavior: 'instant' });
            }).catch(() => location.href = url.toString());
          }
        });

        addEventListener('popstate', () => {
          const url = location.href;
          if (supportsVT){
            (document as any).startViewTransition(() => load(url)).finished.then(() => {
              window.scrollTo({ top: 0, behavior: 'instant' });
            });
          } else {
            load(url).then(() => {
              window.scrollTo({ top: 0, behavior: 'instant' });
            });
          }
        });
      })();

      // Manejo de scroll suave para enlaces internos con hash
      document.addEventListener('click', (e) => {
        const target = e.target as Element;
        const link = target.closest('a');
        if (!link) return;
        
        const href = link.getAttribute('href');
        if (!href || !href.startsWith('/#')) return;
        
        e.preventDefault();
        const id = href.substring(2); // Remover "/#"
        const element = document.getElementById(id);
        
        if (element) {
          element.scrollIntoView({ behavior: 'smooth' });
          // Actualizar URL sin recargar
          history.pushState(null, '', href);
        }
      });
    </script>
  </body>
</html>

<style is:global>
  :root {
    color-scheme: light dark;
  }

  html {
    font-family: "Onest Variable", system-ui, sans-serif;
    scroll-behavior: smooth;
  }

  body {
    color: rgba(17, 17, 17, 0.9);
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    overscroll-behavior: none;
    transition: background-color 200ms ease, color 200ms ease;
    background-color: #f5f5f5;
  }

  /* Fondo decorativo por defecto (claro) */
  .bg-decor {
    background: radial-gradient(ellipse 80% 80% at 50% -20%, rgba(217,216,255,0.5), rgba(255,255,255,0.9));
  }

  /* Preferencia del SO: oscuro para primera pintura sin JS */
  @media (prefers-color-scheme: dark) {
    body { background-color: #0a0a0a; color: rgba(255,255,255,0.9); }
    .bg-decor { background: radial-gradient(ellipse 80% 80% at 50% -20%, rgba(120,119,198,0.3), rgba(255,255,255,0)); }
  }

  /* Forzar según clase .dark (usuario) anula la preferencia del SO */
  html.dark body { background-color: #0a0a0a; color: rgba(255,255,255,0.9); }
  html.dark .bg-decor { background: radial-gradient(ellipse 80% 80% at 50% -20%, rgba(120,119,198,0.3), rgba(255,255,255,0)); }
  html:not(.dark) body { background-color: #f5f5f5; color: rgba(17,17,17,0.9); }
  html:not(.dark) .bg-decor { background: radial-gradient(ellipse 80% 80% at 50% -20%, rgba(217,216,255,0.5), rgba(255,255,255,0.9)); }

  @media (prefers-reduced-motion: reduce) {
    html { scroll-behavior: auto; }
    body { transition: none; }
  }

  /* Estilos para impresión/PDF - Aplicar fondo completo con márgenes para evitar cortes */
  @media print {
    /* Agregar márgenes para evitar cortes abruptos entre páginas */
    @page {
      margin: 1.5cm 0.5cm;
      size: auto;
    }

    /* Ocultar header, footer y navegación completamente */
    header,
    header *,
    header nav,
    header nav *,
    header a,
    header button,
    header svg,
    #theme-toggle,
    #theme-toggle-light-icon,
    #theme-toggle-dark-icon,
    footer,
    footer *,
    nav,
    nav *,
    .print\\:hidden,
    [class*="print:hidden"] {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
      height: 0 !important;
      width: 0 !important;
      margin: 0 !important;
      padding: 0 !important;
      overflow: hidden !important;
    }

    /* Ocultar efectos de gradiente/blur al imprimir */
    [data-gradual-blur],
    [class*="GradualBlur"],
    .gradual-blur,
    .gradual-blur-page,
    .gradual-blur-parent {
      display: none !important;
      visibility: hidden !important;
    }

    /* Ocultar fondo decorativo al imprimir */
    .bg-decor {
      display: none !important;
    }

    /* Forzar modo claro al imprimir: fondo blanco y texto negro */
    html,
    html.dark {
      print-color-adjust: exact !important;
      -webkit-print-color-adjust: exact !important;
      background-color: white !important;
    }

    body,
    html.dark body {
      print-color-adjust: exact !important;
      -webkit-print-color-adjust: exact !important;
      background-color: white !important;
      color: #111111 !important;
      margin: 0 !important;
      padding: 0 !important;
      min-height: 100vh !important;
    }

    /* Forzar todos los textos a negro al imprimir */
    * {
      color: #111111 !important;
    }

    /* Excepción: mantener colores naturales del SVG */
    svg,
    svg * {
      color: inherit !important;
    }

    /* Asegurar que main y article también tengan el fondo */
    main,
    article {
      print-color-adjust: exact !important;
      -webkit-print-color-adjust: exact !important;
      background: transparent !important;
    }

    /* Asegurar que los SVGs se impriman bien */
    svg {
      max-width: 100% !important;
      height: auto !important;
      page-break-inside: avoid;
      print-color-adjust: exact !important;
      -webkit-print-color-adjust: exact !important;
    }

    /* Evitar saltos de página dentro de elementos importantes */
    [data-excal] {
      page-break-inside: avoid;
    }

    /* Asegurar que todos los elementos respeten el fondo */
    * {
      print-color-adjust: exact !important;
      -webkit-print-color-adjust: exact !important;
    }
  }
</style>
